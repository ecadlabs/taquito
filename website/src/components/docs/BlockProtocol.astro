---
interface Props {
  network: string;
  rpcUrl: string;
}

const { network, rpcUrl } = Astro.props;
---

<span class="block-protocol" data-network={network} data-rpc-url={rpcUrl}>Loading...</span>

<script>
  import {
    getController,
    ensureVisibilityHandler
  } from '../../scripts/rpc-block-controller';

  function initBlockProtocol(element: HTMLElement) {
    const rpcUrl = element.dataset.rpcUrl;
    const network = element.dataset.network;

    if (!rpcUrl || !network) return;

    ensureVisibilityHandler();
    const controller = getController(rpcUrl, network);
    let isVisible = false;

    const updateDisplay = () => {
      if (controller.state.loading) {
        element.textContent = 'Loading...';
        element.title = '';
      } else if (controller.state.error) {
        element.textContent = 'Error';
        element.style.color = '#999';
        element.title = '';
      } else if (controller.state.data?.protocol) {
        const protocol = controller.state.data.protocol;
        // Show abbreviated protocol (first 8 chars) with full hash in tooltip
        element.textContent = protocol.substring(0, 8);
        element.title = protocol;
        element.style.color = '';
        element.style.cursor = 'help';
      } else {
        element.textContent = 'Unknown';
        element.title = '';
      }
    };

    const unsubscribe = controller.subscribe(updateDisplay);

    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting && !isVisible) {
          isVisible = true;
          controller.incrementVisibility();
        } else if (!entry.isIntersecting && isVisible) {
          isVisible = false;
          controller.decrementVisibility();
        }
      });
    }, { threshold: 0 });

    observer.observe(element);

    (element as any)._cleanup = () => {
      unsubscribe();
      observer.disconnect();
      if (isVisible) {
        controller.decrementVisibility();
      }
    };
  }

  function initAllProtocols() {
    document.querySelectorAll<HTMLElement>('.block-protocol').forEach((el) => {
      if (!(el as any)._initialized) {
        (el as any)._initialized = true;
        initBlockProtocol(el);
      }
    });
  }

  document.addEventListener('astro:page-load', initAllProtocols);

  const observer = new MutationObserver(() => {
    initAllProtocols();
  });

  if (document.body) {
    observer.observe(document.body, { childList: true, subtree: true });
  }

  document.addEventListener('astro:before-swap', () => {
    observer.disconnect();
    document.querySelectorAll<HTMLElement>('.block-protocol').forEach((el) => {
      if ((el as any)._cleanup) {
        (el as any)._cleanup();
        (el as any)._initialized = false;
      }
    });
  });
</script>
