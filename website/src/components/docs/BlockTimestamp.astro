---
interface Props {
  network: string;
  rpcUrl: string;
}

const { network, rpcUrl } = Astro.props;
---

<span class="block-timestamp" data-network={network} data-rpc-url={rpcUrl}>Loading...</span>

<script>
  import {
    type Controller,
    getController,
    getControllers,
    ensureVisibilityHandler
  } from '../../scripts/rpc-block-controller';

  function initBlockTimestamp(element: HTMLElement) {
    const rpcUrl = element.dataset.rpcUrl;
    const network = element.dataset.network;

    if (!rpcUrl || !network) return;

    ensureVisibilityHandler();
    const controller = getController(rpcUrl, network);
    let isVisible = false;

    const updateDisplay = () => {
      if (controller.state.loading) {
        element.textContent = 'Loading...';
      } else if (controller.state.error) {
        element.textContent = 'Error';
        element.style.color = '#999';
      } else if (controller.state.data?.header?.timestamp) {
        element.textContent = new Date(controller.state.data.header.timestamp).toLocaleString();
        element.style.color = '';
      } else {
        element.textContent = 'Unknown';
      }
    };

    const unsubscribe = controller.subscribe(updateDisplay);

    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting && !isVisible) {
          isVisible = true;
          controller.incrementVisibility();
        } else if (!entry.isIntersecting && isVisible) {
          isVisible = false;
          controller.decrementVisibility();
        }
      });
    }, { threshold: 0 });

    observer.observe(element);

    (element as any)._cleanup = () => {
      unsubscribe();
      observer.disconnect();
      if (isVisible) {
        controller.decrementVisibility();
      }
    };
  }

  function initAllTimestamps() {
    document.querySelectorAll<HTMLElement>('.block-timestamp').forEach((el) => {
      if (!(el as any)._initialized) {
        (el as any)._initialized = true;
        initBlockTimestamp(el);
      }
    });
  }

  document.addEventListener('astro:page-load', initAllTimestamps);

  const observer = new MutationObserver(() => {
    initAllTimestamps();
  });

  if (document.body) {
    observer.observe(document.body, { childList: true, subtree: true });
  }

  document.addEventListener('astro:before-swap', () => {
    observer.disconnect();
    document.querySelectorAll<HTMLElement>('.block-timestamp').forEach((el) => {
      if ((el as any)._cleanup) {
        (el as any)._cleanup();
        (el as any)._initialized = false;
      }
    });
  });
</script>
